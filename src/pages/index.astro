---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import ContentSection from '../components/ContentSection.astro';
import ErrorMessage from '../components/ErrorMessage.astro';
import { getEntryBySlug } from 'astro:content';
import { marked } from 'marked';

const home = await getEntryBySlug('pages', 'home');

// Process sections content
let processedSections: any[] = [];
if (home && home.data.sections) {
  processedSections = await Promise.all(
    home.data.sections.map(async (section: any) => {
      if (section.type === 'text' && section.content) {
        return {
          ...section,
          content: await marked(section.content)
        };
      }
      return section;
    })
  );
}
---

<Layout title={home?.data?.title || "Butoh in Essen"}>
  {home && home.data.hero && (
    <Hero 
      title={home.data.hero.title || "Butoh in Essen"}
      subtitle={home.data.hero.subtitle || "Discover the transformative power of Butoh dance"}
      imageSrc={home.data.hero.image}
      imageAlt="Butoh in Essen"
    />
  )}
  
  <div class="container">
    {processedSections.length > 0 && (
      processedSections.map((section) => (
        <ContentSection>
          {section.type === 'text' && (
            <div>
              <h2>{section.title}</h2>
              <article>
                <Fragment set:html={section.content} />
              </article>
            </div>
          )}
        </ContentSection>
      ))
    )}
    
    {!home && (
      <ContentSection>
        <ErrorMessage 
          title="Home page not found"
          message="Please check that the home content file exists."
        />
      </ContentSection>
    )}
  </div>
</Layout>