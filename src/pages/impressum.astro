---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.jsx';
import ContentSection from '../components/ContentSection.jsx';
import { getEntry } from 'astro:content';
import WorkshopMiniNav from '../components/WorkshopMiniNav.jsx';
import { marked } from 'marked';

const impressum = await getEntry('pages', 'impressum');

console.log('DEBUG: Impressum page - impressum entry:', impressum);
console.log('DEBUG: Impressum page - impressum data:', impressum?.data);
console.log('DEBUG: Impressum page - impressum sections:', impressum?.data?.sections);

// Process sections content
let processedSections: any[] = [];
if (impressum && impressum.data.sections) {
  processedSections = await Promise.all(
    impressum.data.sections.map(async (section: any) => {
      if (section.type === 'text' && section.content) {
        return {
          ...section,
          content: marked(section.content)
        };
      }
      return section;
    })
  );
}

console.log('DEBUG: Impressum page - processedSections:', processedSections);
---

<Layout title={impressum?.data?.title || "Impressum"}>
  {impressum?.data?.hero?.image && (
    import.meta.env.PROD ? (
      <link slot="head" rel="preload" as="image" imagesrcset={`/.netlify/images?url=${encodeURIComponent(impressum.data.hero.image?.startsWith('/') ? impressum.data.hero.image : `/${impressum.data.hero.image}`)}&w=1200&fit=inside&f=avif&q=70 1200w, /.netlify/images?url=${encodeURIComponent(impressum.data.hero.image?.startsWith('/') ? impressum.data.hero.image : `/${impressum.data.hero.image}`)}&w=1600&fit=inside&f=avif&q=70 1600w, /.netlify/images?url=${encodeURIComponent(impressum.data.hero.image?.startsWith('/') ? impressum.data.hero.image : `/${impressum.data.hero.image}`)}&w=1920&fit=inside&f=avif&q=70 1920w`} imagesizes="100vw" />
    ) : (
      <link slot="head" rel="preload" as="image" href={(impressum.data.hero.image?.startsWith('/') ? impressum.data.hero.image : `/${impressum.data.hero.image}`)} />
    )
  )}
  {impressum?.data?.hero && (
    <Hero 
      title={impressum.data.hero.title}
      subtitle={impressum.data.hero.subtitle}
      imageSrc={(impressum.data.hero.image?.startsWith('/') ? impressum.data.hero.image : `/${impressum.data.hero.image}`)}
    />
  )}
  {processedSections.length > 0 && (
    <WorkshopMiniNav client:load sections={processedSections.filter((s) => s?.title && !s?.hideFromNav).map((s, i) => ({ id: `section-${i}`, title: s.title })) as any} />
  )}
  
  <div class="container">
    {processedSections.map((section: any, index: number) => {
      console.log(`DEBUG: Section ${index}:`, section);
      console.log(`DEBUG: Section ${index} mapsUrl:`, section.mapsUrl);
      console.log(`DEBUG: Section ${index} type:`, section.type);
      
      return (
        <ContentSection
          id={`section-${index}`}
          content={section.content}
          title={section.title}
          textColor={section.textColor}
          backgroundColor={section.backgroundColor}
          imagePath={section.imagePath}
          imagePosition={section.imagePosition || "right"}
          imageAlt={section.imageAlt || ""}
          mapsUrl={section.mapsUrl || ""}
        />
      );
    })}
  </div>
</Layout> 